<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å‘ç¯å¢ƒç¦»çº¿æµ‹è¯• - å¤©æ°”å°é¸­</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .online { background: rgba(76, 175, 80, 0.3); }
        .offline { background: rgba(244, 67, 54, 0.3); }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .icon-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .icon-test img {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .alert {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦† å¼€å‘ç¯å¢ƒç¦»çº¿æµ‹è¯•</h1>
        
        <div class="alert">
            <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
            1. è¯·å…ˆæ¸…é™¤æ‰€æœ‰æ—§çš„ Service Worker å’Œç¼“å­˜<br>
            2. ç¡®ä¿è®¿é—®çš„æ˜¯æ­£ç¡®çš„ç«¯å£ (å½“å‰åº”è¯¥æ˜¯ 3001)<br>
            3. ä½¿ç”¨å¼€å‘ç¯å¢ƒä¸“ç”¨çš„ Service Worker
        </div>
        
        <div id="networkStatus" class="status">
            æ£€æµ‹ç½‘ç»œçŠ¶æ€ä¸­...
        </div>

        <div class="test-section">
            <h3>å½“å‰ç¯å¢ƒä¿¡æ¯</h3>
            <div id="envInfo" class="test-result">
                <div>å½“å‰ URL: <span id="currentUrl"></span></div>
                <div>ç«¯å£: <span id="currentPort"></span></div>
                <div>åè®®: <span id="currentProtocol"></span></div>
            </div>
        </div>

        <div class="test-section">
            <h3>Service Worker ç®¡ç†</h3>
            <div id="swStatus" class="test-result">æ£€æµ‹ä¸­...</div>
            <button onclick="clearAllSW()">æ¸…é™¤æ‰€æœ‰ Service Worker</button>
            <button onclick="registerDevSW()">æ³¨å†Œå¼€å‘ç¯å¢ƒ SW</button>
            <button onclick="registerProdSW()">æ³¨å†Œç”Ÿäº§ç¯å¢ƒ SW</button>
        </div>

        <div class="test-section">
            <h3>é™æ€èµ„æºæµ‹è¯•</h3>
            <div class="icon-test">
                <img id="iconTest" src="/icons/icon.svg" alt="å›¾æ ‡æµ‹è¯•" onerror="handleIconError(this)" onload="handleIconLoad(this)">
                <span id="iconStatus">åŠ è½½ä¸­...</span>
            </div>
            <button onclick="testStaticResources()">é‡æ–°æµ‹è¯•é™æ€èµ„æº</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <ol style="text-align: left;">
                <li>ç‚¹å‡»"æ¸…é™¤æ‰€æœ‰ Service Worker"</li>
                <li>ç‚¹å‡»"æ³¨å†Œå¼€å‘ç¯å¢ƒ SW"</li>
                <li>ç­‰å¾…æ³¨å†Œå®Œæˆ</li>
                <li>åœ¨ DevTools Network ä¸­è®¾ç½®ä¸º Offline</li>
                <li>åˆ·æ–°é¡µé¢æµ‹è¯•</li>
            </ol>
            <button onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
            <button onclick="window.location.href='/'">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            if (!logElement) logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        function clearLog() {
            if (logElement) logElement.textContent = '';
        }

        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const isOnline = navigator.onLine;
            statusElement.textContent = isOnline ? 'ğŸŸ¢ åœ¨çº¿æ¨¡å¼' : 'ğŸ”´ ç¦»çº¿æ¨¡å¼';
            statusElement.className = `status ${isOnline ? 'online' : 'offline'}`;
            log(`ç½‘ç»œçŠ¶æ€: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
        }

        function updateEnvInfo() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('currentPort').textContent = window.location.port || 'é»˜è®¤ç«¯å£';
            document.getElementById('currentProtocol').textContent = window.location.protocol;
        }

        function handleIconError(img) {
            document.getElementById('iconStatus').textContent = 'âŒ åŠ è½½å¤±è´¥';
            log('å›¾æ ‡åŠ è½½å¤±è´¥: /icons/icon.svg', 'error');
        }

        function handleIconLoad(img) {
            document.getElementById('iconStatus').textContent = 'âœ… åŠ è½½æˆåŠŸ';
            log('å›¾æ ‡åŠ è½½æˆåŠŸ: /icons/icon.svg');
        }

        async function clearAllSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log(`å‘ç° ${registrations.length} ä¸ª Service Worker`);
                    
                    for (let registration of registrations) {
                        await registration.unregister();
                        log(`å·²æ³¨é”€ Service Worker: ${registration.scope}`);
                    }
                    
                    // æ¸…é™¤ç¼“å­˜
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log(`å·²åˆ é™¤ç¼“å­˜: ${cacheName}`);
                    }
                    
                    log('æ‰€æœ‰ Service Worker å’Œç¼“å­˜å·²æ¸…é™¤');
                    updateSWStatus();
                } catch (error) {
                    log(`æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function registerDevSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw-dev.js');
                    log('å¼€å‘ç¯å¢ƒ Service Worker æ³¨å†ŒæˆåŠŸ');
                    
                    // ç­‰å¾…æ¿€æ´»
                    if (registration.installing) {
                        registration.installing.addEventListener('statechange', function() {
                            if (this.state === 'activated') {
                                log('å¼€å‘ç¯å¢ƒ Service Worker å·²æ¿€æ´»');
                                updateSWStatus();
                            }
                        });
                    } else {
                        updateSWStatus();
                    }
                } catch (error) {
                    log(`å¼€å‘ç¯å¢ƒ Service Worker æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function registerProdSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    log('ç”Ÿäº§ç¯å¢ƒ Service Worker æ³¨å†ŒæˆåŠŸ');
                    updateSWStatus();
                } catch (error) {
                    log(`ç”Ÿäº§ç¯å¢ƒ Service Worker æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function updateSWStatus() {
            const statusElement = document.getElementById('swStatus');
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    const state = registration.active ? registration.active.state : 'æœªæ¿€æ´»';
                    const scriptURL = registration.active ? registration.active.scriptURL : 'æœªçŸ¥';
                    const swType = scriptURL.includes('sw-dev.js') ? 'å¼€å‘ç¯å¢ƒ' : 'ç”Ÿäº§ç¯å¢ƒ';
                    statusElement.innerHTML = `âœ… å·²æ³¨å†Œ ${swType} SW (çŠ¶æ€: ${state})`;
                    statusElement.className = 'test-result success';
                    log(`Service Worker çŠ¶æ€: ${swType}, ${state}`);
                } else {
                    statusElement.innerHTML = 'âŒ æœªæ³¨å†Œ';
                    statusElement.className = 'test-result error';
                }
            } else {
                statusElement.innerHTML = 'âŒ ä¸æ”¯æŒ';
                statusElement.className = 'test-result error';
            }
        }

        function testStaticResources() {
            const iconImg = document.getElementById('iconTest');
            iconImg.src = '/icons/icon.svg?' + Date.now();
            document.getElementById('iconStatus').textContent = 'åŠ è½½ä¸­...';
            log('é‡æ–°æµ‹è¯•é™æ€èµ„æº');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateNetworkStatus();
            updateEnvInfo();
            updateSWStatus();
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            log('å¼€å‘ç¯å¢ƒæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log(`å½“å‰è®¿é—®: ${window.location.href}`);
        });
    </script>
</body>
</html>