<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°”å°é¸­ - è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section h2 {
            margin-bottom: 15px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 500;
        }
        
        .status-value {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-success {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }
        
        .status-warning {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
        
        .status-error {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }
        
        .status-info {
            background: rgba(23, 162, 184, 0.3);
            color: #17a2b8;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦† å¤©æ°”å°é¸­è¯Šæ–­å·¥å…·</h1>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h2>
            <div class="status-item">
                <span class="status-label">æµè§ˆå™¨</span>
                <span class="status-value status-info" id="browser-info">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰URL</span>
                <span class="status-value status-info" id="current-url">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®‰å…¨ä¸Šä¸‹æ–‡</span>
                <span class="status-value" id="secure-context">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç½‘ç»œçŠ¶æ€</span>
                <span class="status-value" id="network-status">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <!-- å®šä½åŠŸèƒ½æ£€æµ‹ -->
        <div class="section">
            <h2>ğŸ“ å®šä½åŠŸèƒ½æ£€æµ‹</h2>
            <div class="status-item">
                <span class="status-label">Geolocation APIæ”¯æŒ</span>
                <span class="status-value" id="geolocation-support">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å®šä½æƒé™çŠ¶æ€</span>
                <span class="status-value" id="geolocation-permission">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰ä½ç½®</span>
                <span class="status-value" id="current-location">æœªè·å–</span>
            </div>
            <div class="actions">
                <button onclick="testGeolocation()" id="test-location-btn">ğŸ§ª æµ‹è¯•å®šä½åŠŸèƒ½</button>
                <button onclick="requestLocationPermission()" id="request-permission-btn">ğŸ” è¯·æ±‚å®šä½æƒé™</button>
            </div>
        </div>
        
        <!-- Service Workeræ£€æµ‹ -->
        <div class="section">
            <h2>âš™ï¸ Service Workeræ£€æµ‹</h2>
            <div class="status-item">
                <span class="status-label">Service Workeræ”¯æŒ</span>
                <span class="status-value" id="sw-support">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å½“å‰SWçŠ¶æ€</span>
                <span class="status-value" id="sw-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç¼“å­˜çŠ¶æ€</span>
                <span class="status-value" id="cache-status">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="actions">
                <button onclick="testServiceWorker()" id="test-sw-btn">ğŸ§ª æµ‹è¯•Service Worker</button>
                <button onclick="clearCaches()" id="clear-cache-btn">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                <button onclick="unregisterSW()" id="unregister-sw-btn">âŒ æ³¨é”€SW</button>
            </div>
        </div>
        
        <!-- å®æ—¶æ—¥å¿— -->
        <div class="section">
            <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>
            <div class="log-area" id="log-area">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
            <div class="actions">
                <button onclick="clearLogs()">ğŸ§¹ æ¸…é™¤æ—¥å¿—</button>
                <button onclick="exportLogs()">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
            </div>
        </div>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="section">
            <h2>ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
            <div class="actions">
                <button onclick="runFullDiagnostic()">ğŸ” å®Œæ•´è¯Šæ–­</button>
                <button onclick="testWeatherAPI()">ğŸŒ¤ï¸ æµ‹è¯•å¤©æ°”API</button>
                <button onclick="window.open('/', '_blank')">ğŸ  æ‰“å¼€ä¸»åº”ç”¨</button>
                <button onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
            </div>
        </div>
    </div>

    <script>
        // æ—¥å¿—ç³»ç»Ÿ
        const logArea = document.getElementById('log-area');
        const logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.push(logEntry);
            logArea.textContent = logs.join('\n');
            logArea.scrollTop = logArea.scrollHeight;
            console.log(logEntry);
        }
        
        function clearLogs() {
            logs.length = 0;
            logArea.textContent = 'æ—¥å¿—å·²æ¸…é™¤...';
        }
        
        function exportLogs() {
            const blob = new Blob([logs.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `weather-duck-debug-${new Date().toISOString().slice(0, 19)}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åŸºæœ¬ä¿¡æ¯æ£€æµ‹
        function detectBasicInfo() {
            // æµè§ˆå™¨ä¿¡æ¯
            const browserInfo = `${navigator.userAgent.split(' ').slice(-2).join(' ')}`;
            document.getElementById('browser-info').textContent = browserInfo;
            
            // å½“å‰URL
            document.getElementById('current-url').textContent = location.href;
            
            // å®‰å…¨ä¸Šä¸‹æ–‡
            const isSecure = window.isSecureContext || location.protocol === 'https:' || 
                           location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const secureElement = document.getElementById('secure-context');
            secureElement.textContent = isSecure ? 'âœ… å®‰å…¨' : 'âŒ ä¸å®‰å…¨';
            secureElement.className = `status-value ${isSecure ? 'status-success' : 'status-error'}`;
            
            // ç½‘ç»œçŠ¶æ€
            const networkElement = document.getElementById('network-status');
            networkElement.textContent = navigator.onLine ? 'âœ… åœ¨çº¿' : 'âŒ ç¦»çº¿';
            networkElement.className = `status-value ${navigator.onLine ? 'status-success' : 'status-error'}`;
            
            addLog(`åŸºæœ¬ä¿¡æ¯æ£€æµ‹å®Œæˆ - æµè§ˆå™¨: ${browserInfo}, å®‰å…¨: ${isSecure}, åœ¨çº¿: ${navigator.onLine}`);
        }
        
        // å®šä½åŠŸèƒ½æ£€æµ‹
        async function detectGeolocation() {
            // Geolocation APIæ”¯æŒ
            const geoSupported = !!navigator.geolocation;
            const geoSupportElement = document.getElementById('geolocation-support');
            geoSupportElement.textContent = geoSupported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            geoSupportElement.className = `status-value ${geoSupported ? 'status-success' : 'status-error'}`;
            
            if (!geoSupported) {
                addLog('æµè§ˆå™¨ä¸æ”¯æŒGeolocation API', 'error');
                return;
            }
            
            // æƒé™çŠ¶æ€
            if ('permissions' in navigator) {
                try {
                    const permission = await navigator.permissions.query({ name: 'geolocation' });
                    const permissionElement = document.getElementById('geolocation-permission');
                    const statusMap = {
                        'granted': { text: 'âœ… å·²æˆæƒ', class: 'status-success' },
                        'denied': { text: 'âŒ å·²æ‹’ç»', class: 'status-error' },
                        'prompt': { text: 'â³ å¾…è¯¢é—®', class: 'status-warning' }
                    };
                    const status = statusMap[permission.state] || { text: 'â“ æœªçŸ¥', class: 'status-info' };
                    permissionElement.textContent = status.text;
                    permissionElement.className = `status-value ${status.class}`;
                    
                    addLog(`å®šä½æƒé™çŠ¶æ€: ${permission.state}`);
                } catch (error) {
                    addLog(`æ— æ³•æŸ¥è¯¢å®šä½æƒé™: ${error.message}`, 'warning');
                }
            } else {
                addLog('æµè§ˆå™¨ä¸æ”¯æŒæƒé™API', 'warning');
            }
        }
        
        // Service Workeræ£€æµ‹
        async function detectServiceWorker() {
            // SWæ”¯æŒ
            const swSupported = 'serviceWorker' in navigator;
            const swSupportElement = document.getElementById('sw-support');
            swSupportElement.textContent = swSupported ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            swSupportElement.className = `status-value ${swSupported ? 'status-success' : 'status-error'}`;
            
            if (!swSupported) {
                addLog('æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'error');
                return;
            }
            
            // SWçŠ¶æ€
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                const swStatusElement = document.getElementById('sw-status');
                
                if (registration) {
                    const sw = registration.active || registration.waiting || registration.installing;
                    if (sw) {
                        swStatusElement.textContent = `âœ… å·²æ³¨å†Œ (${sw.state})`;
                        swStatusElement.className = 'status-value status-success';
                        addLog(`Service WorkerçŠ¶æ€: ${sw.state}, URL: ${sw.scriptURL}`);
                    } else {
                        swStatusElement.textContent = 'â³ æ³¨å†Œä¸­';
                        swStatusElement.className = 'status-value status-warning';
                        addLog('Service Workeræ­£åœ¨æ³¨å†Œä¸­');
                    }
                } else {
                    swStatusElement.textContent = 'âŒ æœªæ³¨å†Œ';
                    swStatusElement.className = 'status-value status-error';
                    addLog('æœªæ‰¾åˆ°Service Workeræ³¨å†Œ');
                }
            } catch (error) {
                addLog(`æ£€æŸ¥Service Workerå¤±è´¥: ${error.message}`, 'error');
            }
            
            // ç¼“å­˜çŠ¶æ€
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    const cacheStatusElement = document.getElementById('cache-status');
                    cacheStatusElement.textContent = `âœ… ${cacheNames.length}ä¸ªç¼“å­˜`;
                    cacheStatusElement.className = 'status-value status-success';
                    addLog(`å‘ç°${cacheNames.length}ä¸ªç¼“å­˜: ${cacheNames.join(', ')}`);
                } catch (error) {
                    addLog(`æ£€æŸ¥ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                addLog('æµè§ˆå™¨ä¸æ”¯æŒCache API', 'warning');
            }
        }
        
        // æµ‹è¯•å®šä½åŠŸèƒ½
        async function testGeolocation() {
            const btn = document.getElementById('test-location-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> å®šä½ä¸­...';
            
            addLog('å¼€å§‹æµ‹è¯•å®šä½åŠŸèƒ½...');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });
                
                const { latitude, longitude, accuracy } = position.coords;
                const locationElement = document.getElementById('current-location');
                locationElement.textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)} (Â±${Math.round(accuracy)}m)`;
                locationElement.className = 'status-value status-success';
                
                addLog(`å®šä½æˆåŠŸ: çº¬åº¦=${latitude}, ç»åº¦=${longitude}, ç²¾åº¦=Â±${accuracy}m`);
            } catch (error) {
                const locationElement = document.getElementById('current-location');
                locationElement.textContent = `âŒ ${error.message}`;
                locationElement.className = 'status-value status-error';
                
                addLog(`å®šä½å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // è¯·æ±‚å®šä½æƒé™
        async function requestLocationPermission() {
            addLog('è¯·æ±‚å®šä½æƒé™...');
            
            try {
                // ç›´æ¥è°ƒç”¨getCurrentPositionæ¥è§¦å‘æƒé™è¯·æ±‚
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 5000
                    });
                });
                
                addLog('å®šä½æƒé™å·²æˆæƒ');
                await detectGeolocation(); // é‡æ–°æ£€æµ‹æƒé™çŠ¶æ€
            } catch (error) {
                addLog(`æƒé™è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•Service Worker
        async function testServiceWorker() {
            const btn = document.getElementById('test-sw-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';
            
            addLog('å¼€å§‹æµ‹è¯•Service Worker...');
            
            try {
                // å°è¯•æ³¨å†ŒSW
                const registration = await navigator.serviceWorker.register('/sw.js');
                addLog(`Service Workeræ³¨å†ŒæˆåŠŸ: ${registration.scope}`);
                
                // ç­‰å¾…SWæ¿€æ´»
                if (registration.installing) {
                    addLog('ç­‰å¾…Service Workerå®‰è£…...');
                    await new Promise(resolve => {
                        registration.installing.addEventListener('statechange', () => {
                            if (registration.installing.state === 'activated') {
                                resolve();
                            }
                        });
                    });
                }
                
                addLog('Service Workeræµ‹è¯•å®Œæˆ');
                await detectServiceWorker(); // é‡æ–°æ£€æµ‹çŠ¶æ€
            } catch (error) {
                addLog(`Service Workeræµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // æ¸…é™¤ç¼“å­˜
        async function clearCaches() {
            addLog('å¼€å§‹æ¸…é™¤ç¼“å­˜...');
            
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                addLog(`å·²æ¸…é™¤${cacheNames.length}ä¸ªç¼“å­˜`);
                await detectServiceWorker(); // é‡æ–°æ£€æµ‹çŠ¶æ€
            } catch (error) {
                addLog(`æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ³¨é”€Service Worker
        async function unregisterSW() {
            addLog('å¼€å§‹æ³¨é”€Service Worker...');
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    addLog('Service Workerå·²æ³¨é”€');
                } else {
                    addLog('æ²¡æœ‰æ‰¾åˆ°è¦æ³¨é”€çš„Service Worker');
                }
                await detectServiceWorker(); // é‡æ–°æ£€æµ‹çŠ¶æ€
            } catch (error) {
                addLog(`æ³¨é”€Service Workerå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å®Œæ•´è¯Šæ–­
        async function runFullDiagnostic() {
            addLog('=== å¼€å§‹å®Œæ•´è¯Šæ–­ ===');
            
            detectBasicInfo();
            await detectGeolocation();
            await detectServiceWorker();
            
            addLog('=== å®Œæ•´è¯Šæ–­ç»“æŸ ===');
        }
        
        // æµ‹è¯•å¤©æ°”API
        async function testWeatherAPI() {
            addLog('æµ‹è¯•å¤©æ°”API...');
            
            try {
                // æµ‹è¯•å®šä½
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 5000
                    });
                });
                
                const { latitude, longitude } = position.coords;
                addLog(`ä½¿ç”¨ä½ç½®: ${latitude}, ${longitude}`);
                
                // æµ‹è¯•å¤©æ°”API
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${new Date().toISOString().slice(0, 10)}&end_date=${new Date().toISOString().slice(0, 10)}`;
                
                const response = await fetch(weatherUrl);
                if (response.ok) {
                    const data = await response.json();
                    addLog(`å¤©æ°”APIæµ‹è¯•æˆåŠŸ: ${JSON.stringify(data, null, 2)}`);
                } else {
                    addLog(`å¤©æ°”APIå“åº”é”™è¯¯: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`å¤©æ°”APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºæœ¬æ£€æµ‹
        window.addEventListener('load', () => {
            addLog('è¯Šæ–­å·¥å…·å·²åŠ è½½');
            runFullDiagnostic();
        });
        
        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            addLog('ç½‘ç»œå·²è¿æ¥');
            document.getElementById('network-status').textContent = 'âœ… åœ¨çº¿';
            document.getElementById('network-status').className = 'status-value status-success';
        });
        
        window.addEventListener('offline', () => {
            addLog('ç½‘ç»œå·²æ–­å¼€');
            document.getElementById('network-status').textContent = 'âŒ ç¦»çº¿';
            document.getElementById('network-status').className = 'status-value status-error';
        });
    </script>
</body>
</html>