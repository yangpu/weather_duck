<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°”å°é¸­æ—¥è®° - PWAç‰ˆ</title>
    <meta name="description" content="è®°å½•å¤©æ°”å’Œå¿ƒæƒ…çš„æ—¥è®°åº”ç”¨">
    <meta name="theme-color" content="#4A90E2">
    
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.svg">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .status-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .weather-section {
            margin: 20px 0;
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .weather-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .diary-section {
            margin: 20px 0;
        }
        
        .diary-entry {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .diary-date {
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 8px;
        }
        
        .diary-content {
            line-height: 1.6;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .online { color: #4CAF50; }
        .offline { color: #f44336; }
        
        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .install-prompt {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .card {
                padding: 20px;
                margin: 15px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¦† å¤©æ°”å°é¸­æ—¥è®°</h1>
        <p class="subtitle">è®°å½•å¤©æ°”ä¸å¿ƒæƒ…çš„ç¾å¥½æ—¶å…‰</p>
    </div>
    
    <div class="main-content">
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <div class="status-card">
                <div class="status-item">
                    <div class="status-icon" id="networkIcon">ğŸŒ</div>
                    <div>ç½‘ç»œçŠ¶æ€</div>
                    <div id="networkStatus">æ£€æµ‹ä¸­...</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">âš™ï¸</div>
                    <div>Service Worker</div>
                    <div id="swStatus">æ£€æµ‹ä¸­...</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">ğŸ’¾</div>
                    <div>ç¼“å­˜çŠ¶æ€</div>
                    <div id="cacheStatus">æ£€æµ‹ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- å®‰è£…æç¤º -->
        <div id="installPrompt" class="install-prompt" style="display: none;">
            <h3>ğŸ“± å®‰è£…åº”ç”¨åˆ°æ¡Œé¢</h3>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†å¤©æ°”å°é¸­å®‰è£…åˆ°æ‚¨çš„è®¾å¤‡ä¸Šï¼Œäº«å—æ›´å¥½çš„ç¦»çº¿ä½“éªŒï¼</p>
            <button id="installButton">å®‰è£…åº”ç”¨</button>
            <button onclick="dismissInstallPrompt()">ç¨åå†è¯´</button>
        </div>
        
        <!-- å¤©æ°”ä¿¡æ¯ -->
        <div class="card weather-section">
            <h2>ğŸŒ¤ï¸ ä»Šæ—¥å¤©æ°”</h2>
            <div id="weatherContent" class="loading">åŠ è½½å¤©æ°”æ•°æ®ä¸­...</div>
        </div>
        
        <!-- æ—¥è®°æ¡ç›® -->
        <div class="card diary-section">
            <h2>ğŸ“ æœ€è¿‘æ—¥è®°</h2>
            <div id="diaryContent" class="loading">åŠ è½½æ—¥è®°æ•°æ®ä¸­...</div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="card">
            <div class="controls">
                <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜</button>
                <button onclick="toggleOfflineMode()">ğŸ“± ç¦»çº¿æ¨¡å¼æµ‹è¯•</button>
                <button onclick="showDebugInfo()">ğŸ” è°ƒè¯•ä¿¡æ¯</button>
            </div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div id="debugInfo" class="card" style="display: none;">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        // PWA ç›¸å…³å˜é‡
        let deferredPrompt;
        let isOfflineMode = false;
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('PWA åº”ç”¨åˆå§‹åŒ–...');
            
            // æ³¨å†Œ Service Worker
            await registerServiceWorker();
            
            // æ›´æ–°çŠ¶æ€
            updateNetworkStatus();
            updateServiceWorkerStatus();
            updateCacheStatus();
            
            // åŠ è½½æ•°æ®
            await loadWeatherData();
            await loadDiaryData();
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // ç›‘å¬ PWA å®‰è£…æç¤º
            window.addEventListener('beforeinstallprompt', handleInstallPrompt);
            
            console.log('PWA åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        });
        
        // æ³¨å†Œ Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // å…ˆæ¸…é™¤æ—§çš„ Service Worker
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                    
                    // æ³¨å†Œæ–°çš„ Service Worker
                    const registration = await navigator.serviceWorker.register('/sw-pwa.js');
                    console.log('PWA Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    
                    // ç›‘å¬æ›´æ–°
                    registration.addEventListener('updatefound', () => {
                        console.log('å‘ç° Service Worker æ›´æ–°');
                    });
                    
                } catch (error) {
                    console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            }
        }
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€
        function updateNetworkStatus() {
            const isOnline = navigator.onLine && !isOfflineMode;
            const statusElement = document.getElementById('networkStatus');
            const iconElement = document.getElementById('networkIcon');
            
            if (isOnline) {
                statusElement.innerHTML = '<span class="online">åœ¨çº¿</span>';
                iconElement.textContent = 'ğŸŒ';
            } else {
                statusElement.innerHTML = '<span class="offline">ç¦»çº¿</span>';
                iconElement.textContent = 'ğŸ“±';
            }
        }
        
        // æ›´æ–° Service Worker çŠ¶æ€
        async function updateServiceWorkerStatus() {
            const statusElement = document.getElementById('swStatus');
            
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration && registration.active) {
                    statusElement.innerHTML = '<span class="online">å·²æ¿€æ´»</span>';
                } else {
                    statusElement.innerHTML = '<span class="offline">æœªæ¿€æ´»</span>';
                }
            } else {
                statusElement.innerHTML = '<span class="offline">ä¸æ”¯æŒ</span>';
            }
        }
        
        // æ›´æ–°ç¼“å­˜çŠ¶æ€
        async function updateCacheStatus() {
            const statusElement = document.getElementById('cacheStatus');
            
            try {
                const cacheNames = await caches.keys();
                let totalItems = 0;
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    totalItems += keys.length;
                }
                
                statusElement.innerHTML = `<span class="online">${totalItems} é¡¹</span>`;
            } catch (error) {
                statusElement.innerHTML = '<span class="offline">æ£€æµ‹å¤±è´¥</span>';
            }
        }
        
        // åŠ è½½å¤©æ°”æ•°æ®
        async function loadWeatherData() {
            const weatherContent = document.getElementById('weatherContent');
            
            try {
                // æ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­ä» API è·å–ï¼‰
                const weatherData = getLocalWeatherData() || {
                    temperature: '22Â°C',
                    condition: 'å¤šäº‘',
                    humidity: '65%',
                    windSpeed: '5 km/h'
                };
                
                weatherContent.innerHTML = `
                    <div class="weather-grid">
                        <div class="weather-item">
                            <div>ğŸŒ¡ï¸</div>
                            <div>æ¸©åº¦</div>
                            <div>${weatherData.temperature}</div>
                        </div>
                        <div class="weather-item">
                            <div>â˜ï¸</div>
                            <div>å¤©æ°”</div>
                            <div>${weatherData.condition}</div>
                        </div>
                        <div class="weather-item">
                            <div>ğŸ’§</div>
                            <div>æ¹¿åº¦</div>
                            <div>${weatherData.humidity}</div>
                        </div>
                        <div class="weather-item">
                            <div>ğŸ’¨</div>
                            <div>é£é€Ÿ</div>
                            <div>${weatherData.windSpeed}</div>
                        </div>
                    </div>
                `;
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveLocalWeatherData(weatherData);
                
            } catch (error) {
                weatherContent.innerHTML = `
                    <div class="error">
                        <p>âš ï¸ å¤©æ°”æ•°æ®åŠ è½½å¤±è´¥</p>
                        <p>ç¦»çº¿æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼“å­˜æ•°æ®</p>
                    </div>
                `;
            }
        }
        
        // åŠ è½½æ—¥è®°æ•°æ®
        async function loadDiaryData() {
            const diaryContent = document.getElementById('diaryContent');
            
            try {
                const diaryEntries = getLocalDiaryData() || [
                    {
                        date: '2025-09-30',
                        content: 'ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œå¿ƒæƒ…ä¹Ÿå¾ˆå¥½ã€‚å°é¸­å­åœ¨æ± å¡˜é‡Œæ¸¸æ³³ï¼Œçœ‹èµ·æ¥å¾ˆå¼€å¿ƒã€‚'
                    },
                    {
                        date: '2025-09-29',
                        content: 'ä¸‹äº†ä¸€ç‚¹å°é›¨ï¼Œç©ºæ°”å¾ˆæ¸…æ–°ã€‚å†™ä»£ç çš„æ—¶å€™å¬ç€é›¨å£°ï¼Œç‰¹åˆ«æœ‰æ„Ÿè§‰ã€‚'
                    }
                ];
                
                diaryContent.innerHTML = diaryEntries.map(entry => `
                    <div class="diary-entry">
                        <div class="diary-date">ğŸ“… ${entry.date}</div>
                        <div class="diary-content">${entry.content}</div>
                    </div>
                `).join('');
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveLocalDiaryData(diaryEntries);
                
            } catch (error) {
                diaryContent.innerHTML = `
                    <div class="error">
                        <p>âš ï¸ æ—¥è®°æ•°æ®åŠ è½½å¤±è´¥</p>
                        <p>ç¦»çº¿æ¨¡å¼ä¸‹æ˜¾ç¤ºç¼“å­˜æ•°æ®</p>
                    </div>
                `;
            }
        }
        
        // æœ¬åœ°å­˜å‚¨æ“ä½œ
        function getLocalWeatherData() {
            try {
                return JSON.parse(localStorage.getItem('pwa_weather_data'));
            } catch {
                return null;
            }
        }
        
        function saveLocalWeatherData(data) {
            localStorage.setItem('pwa_weather_data', JSON.stringify(data));
        }
        
        function getLocalDiaryData() {
            try {
                return JSON.parse(localStorage.getItem('pwa_diary_data'));
            } catch {
                return null;
            }
        }
        
        function saveLocalDiaryData(data) {
            localStorage.setItem('pwa_diary_data', JSON.stringify(data));
        }
        
        // äº‹ä»¶å¤„ç†
        function handleOnline() {
            console.log('ç½‘ç»œå·²è¿æ¥');
            updateNetworkStatus();
            refreshData();
        }
        
        function handleOffline() {
            console.log('ç½‘ç»œå·²æ–­å¼€');
            updateNetworkStatus();
        }
        
        function handleInstallPrompt(e) {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        }
        
        // æ§åˆ¶å‡½æ•°
        async function refreshData() {
            console.log('åˆ·æ–°æ•°æ®...');
            await loadWeatherData();
            await loadDiaryData();
            updateCacheStatus();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showMessage('æ•°æ®å·²åˆ·æ–°', 'success');
        }
        
        async function clearCache() {
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                localStorage.clear();
                
                updateCacheStatus();
                showMessage('ç¼“å­˜å·²æ¸…é™¤', 'success');
            } catch (error) {
                showMessage('æ¸…é™¤ç¼“å­˜å¤±è´¥', 'error');
            }
        }
        
        function toggleOfflineMode() {
            isOfflineMode = !isOfflineMode;
            updateNetworkStatus();
            showMessage(isOfflineMode ? 'å·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å¼', 'success');
        }
        
        function showDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            debugContent.innerHTML = `
                <p><strong>ç”¨æˆ·ä»£ç†:</strong> ${navigator.userAgent}</p>
                <p><strong>å½“å‰ URL:</strong> ${window.location.href}</p>
                <p><strong>ç½‘ç»œçŠ¶æ€:</strong> ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}</p>
                <p><strong>Service Worker æ”¯æŒ:</strong> ${'serviceWorker' in navigator ? 'æ˜¯' : 'å¦'}</p>
                <p><strong>ç¼“å­˜ API æ”¯æŒ:</strong> ${'caches' in window ? 'æ˜¯' : 'å¦'}</p>
                <p><strong>æœ¬åœ°å­˜å‚¨:</strong> ${localStorage.length} é¡¹</p>
                <p><strong>æ—¶é—´æˆ³:</strong> ${new Date().toLocaleString()}</p>
            `;
            
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // å®‰è£…åº”ç”¨
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('å®‰è£…ç»“æœ:', outcome);
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        }
        
        function dismissInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = `<p>${message}</p>`;
            
            document.querySelector('.main-content').insertBefore(
                messageDiv, 
                document.querySelector('.main-content').firstChild
            );
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // ç»‘å®šå®‰è£…æŒ‰é’®
        document.getElementById('installButton').addEventListener('click', installApp);
    </script>
</body>
</html>