<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦»çº¿æ¨¡å¼æµ‹è¯• - å¤©æ°”å°é¸­</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .online { background: rgba(76, 175, 80, 0.3); }
        .offline { background: rgba(244, 67, 54, 0.3); }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .icon-test {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .icon-test img {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦† å¤©æ°”å°é¸­ - ç¦»çº¿æ¨¡å¼æµ‹è¯•</h1>
        
        <div id="networkStatus" class="status">
            æ£€æµ‹ç½‘ç»œçŠ¶æ€ä¸­...
        </div>

        <div class="test-section">
            <h3>Service Worker çŠ¶æ€</h3>
            <div id="swStatus" class="test-result">æ£€æµ‹ä¸­...</div>
            <button onclick="registerSW()">é‡æ–°æ³¨å†Œ Service Worker</button>
            <button onclick="unregisterSW()">æ³¨é”€ Service Worker</button>
        </div>

        <div class="test-section">
            <h3>é™æ€èµ„æºæµ‹è¯•</h3>
            <div class="icon-test">
                <img id="iconTest" src="/icons/icon.svg" alt="å›¾æ ‡æµ‹è¯•" onerror="handleIconError(this)">
                <span id="iconStatus">åŠ è½½ä¸­...</span>
            </div>
            <div class="icon-test">
                <img id="faviconTest" src="/favicon.svg" alt="Faviconæµ‹è¯•" onerror="handleFaviconError(this)">
                <span id="faviconStatus">åŠ è½½ä¸­...</span>
            </div>
            <button onclick="testStaticResources()">é‡æ–°æµ‹è¯•é™æ€èµ„æº</button>
        </div>

        <div class="test-section">
            <h3>ç¼“å­˜çŠ¶æ€</h3>
            <div id="cacheStatus" class="test-result">æ£€æµ‹ä¸­...</div>
            <button onclick="checkCaches()">æ£€æŸ¥ç¼“å­˜</button>
            <button onclick="clearCaches()">æ¸…é™¤ç¼“å­˜</button>
        </div>

        <div class="test-section">
            <h3>æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>æµ‹è¯•æ“ä½œ</h3>
            <button onclick="simulateOffline()">æ¨¡æ‹Ÿç¦»çº¿æ¨¡å¼</button>
            <button onclick="testManifest()">æµ‹è¯• Manifest</button>
            <button onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
            <button onclick="window.location.href='/'">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <script>
        let logElement;

        function log(message, type = 'info') {
            if (!logElement) logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        function clearLog() {
            if (logElement) logElement.textContent = '';
        }

        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const isOnline = navigator.onLine;
            statusElement.textContent = isOnline ? 'ğŸŸ¢ åœ¨çº¿æ¨¡å¼' : 'ğŸ”´ ç¦»çº¿æ¨¡å¼';
            statusElement.className = `status ${isOnline ? 'online' : 'offline'}`;
            log(`ç½‘ç»œçŠ¶æ€: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);
        }

        function handleIconError(img) {
            document.getElementById('iconStatus').textContent = 'âŒ åŠ è½½å¤±è´¥';
            log('å›¾æ ‡åŠ è½½å¤±è´¥: /icons/icon.svg', 'error');
        }

        function handleFaviconError(img) {
            document.getElementById('faviconStatus').textContent = 'âŒ åŠ è½½å¤±è´¥';
            log('FaviconåŠ è½½å¤±è´¥: /favicon.svg', 'error');
        }

        async function registerSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    log('Service Worker æ³¨å†ŒæˆåŠŸ');
                    updateSWStatus();
                } catch (error) {
                    log(`Service Worker æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('æµè§ˆå™¨ä¸æ”¯æŒ Service Worker', 'warning');
            }
        }

        async function unregisterSW() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                }
                log('Service Worker å·²æ³¨é”€');
                updateSWStatus();
            }
        }

        async function updateSWStatus() {
            const statusElement = document.getElementById('swStatus');
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    const state = registration.active ? registration.active.state : 'æœªæ¿€æ´»';
                    statusElement.innerHTML = `âœ… å·²æ³¨å†Œ (çŠ¶æ€: ${state})`;
                    statusElement.className = 'test-result success';
                } else {
                    statusElement.innerHTML = 'âŒ æœªæ³¨å†Œ';
                    statusElement.className = 'test-result error';
                }
            } else {
                statusElement.innerHTML = 'âŒ ä¸æ”¯æŒ';
                statusElement.className = 'test-result error';
            }
        }

        function testStaticResources() {
            // é‡æ–°åŠ è½½å›¾æ ‡
            const iconImg = document.getElementById('iconTest');
            const faviconImg = document.getElementById('faviconTest');
            
            iconImg.src = '/icons/icon.svg?' + Date.now();
            faviconImg.src = '/favicon.svg?' + Date.now();
            
            document.getElementById('iconStatus').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('faviconStatus').textContent = 'åŠ è½½ä¸­...';
            
            // æ£€æŸ¥åŠ è½½ç»“æœ
            setTimeout(() => {
                if (iconImg.complete && iconImg.naturalWidth > 0) {
                    document.getElementById('iconStatus').textContent = 'âœ… åŠ è½½æˆåŠŸ';
                    log('å›¾æ ‡åŠ è½½æˆåŠŸ: /icons/icon.svg');
                }
                if (faviconImg.complete && faviconImg.naturalWidth > 0) {
                    document.getElementById('faviconStatus').textContent = 'âœ… åŠ è½½æˆåŠŸ';
                    log('FaviconåŠ è½½æˆåŠŸ: /favicon.svg');
                }
            }, 1000);
        }

        async function checkCaches() {
            const statusElement = document.getElementById('cacheStatus');
            try {
                const cacheNames = await caches.keys();
                log(`å‘ç°ç¼“å­˜: ${cacheNames.join(', ')}`);
                
                let totalCached = 0;
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    totalCached += keys.length;
                    log(`ç¼“å­˜ ${cacheName}: ${keys.length} ä¸ªèµ„æº`);
                }
                
                statusElement.innerHTML = `âœ… å…± ${cacheNames.length} ä¸ªç¼“å­˜ï¼Œ${totalCached} ä¸ªèµ„æº`;
                statusElement.className = 'test-result success';
            } catch (error) {
                statusElement.innerHTML = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
                statusElement.className = 'test-result error';
                log(`ç¼“å­˜æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearCaches() {
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                log('æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤');
                checkCaches();
            } catch (error) {
                log(`æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateOffline() {
            log('æç¤º: è¯·åœ¨ Chrome DevTools > Network ä¸­è®¾ç½®ä¸º Offline æ¨¡å¼');
            alert('è¯·åœ¨ Chrome DevTools > Network ä¸­è®¾ç½®ä¸º Offline æ¨¡å¼ï¼Œç„¶ååˆ·æ–°é¡µé¢æµ‹è¯•ç¦»çº¿åŠŸèƒ½');
        }

        async function testManifest() {
            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();
                log('Manifest åŠ è½½æˆåŠŸ');
                log(`åº”ç”¨åç§°: ${manifest.name}`);
                log(`å›¾æ ‡æ•°é‡: ${manifest.icons.length}`);
            } catch (error) {
                log(`Manifest åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateNetworkStatus();
            updateSWStatus();
            checkCaches();
            testStaticResources();
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            
            log('ç¦»çº¿æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>