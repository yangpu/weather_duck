<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹Ÿå™¨å®šä½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ¨¡æ‹Ÿå™¨å®šä½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•åœ¨å¼€å‘è€…å·¥å…·è®¾å¤‡æ¨¡æ‹Ÿæ¨¡å¼ä¸‹çš„å®šä½åŠŸèƒ½ã€‚</p>
        
        <button class="btn" onclick="runDetection()">ğŸ” æ£€æµ‹ç¯å¢ƒ</button>
        <button class="btn" onclick="testLocation()">ğŸ“ æµ‹è¯•å®šä½</button>
        <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        
        <div id="results"></div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px;">
            <h3>é¢„æœŸè¡Œä¸ºï¼š</h3>
            <ul>
                <li><strong>çœŸå® iOS è®¾å¤‡ï¼š</strong>å¯ç”¨ iOS ä¼˜åŒ–ï¼Œå¤šæ¬¡é‡è¯•ï¼Œè¯¦ç»†é”™è¯¯å¤„ç†</li>
                <li><strong>æ¨¡æ‹Ÿå™¨ç¯å¢ƒï¼š</strong>ä½¿ç”¨æ ‡å‡†é…ç½®ï¼ŒCoreLocation é”™è¯¯è¢«æ­£ç¡®è¯†åˆ«ä¸ºæ¨¡æ‹Ÿå™¨é™åˆ¶</li>
                <li><strong>æ¡Œé¢æµè§ˆå™¨ï¼š</strong>ä½¿ç”¨æ ‡å‡† Web API é…ç½®</li>
            </ul>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        function runDetection() {
            addResult('=== ç¯å¢ƒæ£€æµ‹å¼€å§‹ ===', 'info');
            
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const hasTouch = 'ontouchstart' in window;
            const hasOrientation = 'orientation' in window;
            const hasDesktopOS = ua.toLowerCase().includes('macintosh') || 
                               ua.toLowerCase().includes('windows') || 
                               ua.toLowerCase().includes('linux');
            const isDevTools = ua.includes('chrome') && !ua.includes('crios') && !ua.includes('mobile');
            
            addResult(`User Agent: ${ua}`, 'info');
            addResult(`iOS æ£€æµ‹: ${isIOS ? 'æ˜¯' : 'å¦'}`, isIOS ? 'warning' : 'info');
            addResult(`è§¦æ‘¸æ”¯æŒ: ${hasTouch ? 'æ˜¯' : 'å¦'}`, 'info');
            addResult(`æ–¹å‘æ”¯æŒ: ${hasOrientation ? 'æ˜¯' : 'å¦'}`, 'info');
            addResult(`æ¡Œé¢ç³»ç»Ÿ: ${hasDesktopOS ? 'æ˜¯' : 'å¦'}`, hasDesktopOS ? 'warning' : 'info');
            addResult(`å¼€å‘å·¥å…·: ${isDevTools ? 'æ˜¯' : 'å¦'}`, isDevTools ? 'warning' : 'info');
            
            // æ¨¡æ‹ŸçœŸå®è®¾å¤‡æ£€æµ‹é€»è¾‘
            const isRealDevice = hasTouch && hasOrientation && !hasDesktopOS && !isDevTools;
            const deviceType = isIOS ? (isRealDevice ? 'çœŸå® iOS è®¾å¤‡' : 'iOS æ¨¡æ‹Ÿå™¨') : 'é iOS è®¾å¤‡';
            
            addResult(`è®¾å¤‡ç±»å‹åˆ¤æ–­: ${deviceType}`, isRealDevice ? 'success' : 'warning');
            addResult('=== ç¯å¢ƒæ£€æµ‹å®Œæˆ ===', 'info');
        }
        
        async function testLocation() {
            addResult('=== å®šä½æµ‹è¯•å¼€å§‹ ===', 'info');
            
            if (!navigator.geolocation) {
                addResult('æµè§ˆå™¨ä¸æ”¯æŒå®šä½ API', 'error');
                return;
            }
            
            const startTime = Date.now();
            
            // æ¨¡æ‹Ÿæˆ‘ä»¬çš„æ£€æµ‹é€»è¾‘
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const hasTouch = 'ontouchstart' in window;
            const hasOrientation = 'orientation' in window;
            const hasDesktopOS = ua.toLowerCase().includes('macintosh') || 
                               ua.toLowerCase().includes('windows') || 
                               ua.toLowerCase().includes('linux');
            const isDevTools = ua.includes('chrome') && !ua.includes('crios') && !ua.includes('mobile');
            const isRealDevice = hasTouch && hasOrientation && !hasDesktopOS && !isDevTools;
            
            const useIOSOptimization = isIOS && isRealDevice;
            
            addResult(`ä½¿ç”¨ iOS ä¼˜åŒ–: ${useIOSOptimization ? 'æ˜¯' : 'å¦'}`, useIOSOptimization ? 'success' : 'info');
            
            const options = {
                enableHighAccuracy: useIOSOptimization,
                timeout: useIOSOptimization ? 15000 : 6000,
                maximumAge: useIOSOptimization ? 60000 : 300000
            };
            
            addResult(`å®šä½é€‰é¡¹: ${JSON.stringify(options)}`, 'info');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
                
                const duration = Date.now() - startTime;
                addResult(`âœ… å®šä½æˆåŠŸ (${duration}ms)`, 'success');
                addResult(`åæ ‡: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`, 'success');
                addResult(`ç²¾åº¦: ${position.coords.accuracy?.toFixed(0) || 'N/A'}m`, 'success');
                
            } catch (error) {
                const duration = Date.now() - startTime;
                const isCoreLocationError = error.message && error.message.includes('kCLErrorLocationUnknown');
                const isSimulator = isIOS && !isRealDevice;
                
                addResult(`âŒ å®šä½å¤±è´¥ (${duration}ms)`, 'error');
                addResult(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
                addResult(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
                addResult(`CoreLocation é”™è¯¯: ${isCoreLocationError ? 'æ˜¯' : 'å¦'}`, isCoreLocationError ? 'warning' : 'info');
                addResult(`æ¨¡æ‹Ÿå™¨ç¯å¢ƒ: ${isSimulator ? 'æ˜¯' : 'å¦'}`, isSimulator ? 'warning' : 'info');
                
                if (isSimulator && isCoreLocationError) {
                    addResult('âœ… æ­£ç¡®è¯†åˆ«ä¸ºæ¨¡æ‹Ÿå™¨ CoreLocation é™åˆ¶', 'success');
                } else if (isCoreLocationError && isRealDevice) {
                    addResult('âš ï¸ çœŸå® iOS è®¾å¤‡ CoreLocation é”™è¯¯', 'warning');
                }
                
                // æ¨¡æ‹Ÿ IP å®šä½é™çº§
                try {
                    addResult('å°è¯• IP å®šä½...', 'info');
                    const response = await fetch('https://ipinfo.io/json');
                    const data = await response.json();
                    if (data.loc) {
                        const [lat, lng] = data.loc.split(',').map(parseFloat);
                        addResult(`âœ… IP å®šä½æˆåŠŸ: ${lat}, ${lng}`, 'success');
                    }
                } catch (ipError) {
                    addResult(`âŒ IP å®šä½å¤±è´¥: ${ipError.message}`, 'error');
                    addResult('âœ… å°†ä½¿ç”¨é»˜è®¤ä½ç½®: æ·±åœ³ (22.5429, 114.0596)', 'warning');
                }
            }
            
            addResult('=== å®šä½æµ‹è¯•å®Œæˆ ===', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', runDetection);
    </script>
</body>
</html>