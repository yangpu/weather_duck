server {
    listen 443 ssl http2;
    server_name yangruoji.com;  
    
    ssl_certificate /etc/letsencrypt/live/yangruoji.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yangruoji.com/privkey.pem;
    
    # SSL优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 启用gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json application/xml+rss image/svg+xml;
    
    # 默认跳转
    location = / {
        return 301 /weather_duck/;
    }

    # spellingbee - 使用alias
    location /spellingbee/ {
        alias /usr/share/nginx/html/spellingbee/;
        index index.html;
        
        # Service Worker - 绝对不缓存
        location ~ /spellingbee/sw\.js$ {
            alias /usr/share/nginx/html/spellingbee/sw.js;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            add_header Service-Worker-Allowed "/spellingbee/";
        }
        
        # manifest.json - 短期缓存
        location ~ /spellingbee/manifest\.json$ {
            alias /usr/share/nginx/html/spellingbee/manifest.json;
            add_header Cache-Control "public, max-age=3600";
        }
        
        # 静态资源 - 长期缓存
        location ~ /spellingbee/assets/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # SPA路由处理
        try_files $uri $uri/ /spellingbee/index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # weather_duck - 使用alias
    location /weather_duck/ {
        alias /usr/share/nginx/html/weather_duck/;
        index index.html;
        
        # Service Worker - 绝对不缓存
        location ~ /weather_duck/sw\.js$ {
            alias /usr/share/nginx/html/weather_duck/sw.js;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            add_header Service-Worker-Allowed "/weather_duck/";
        }
        
        # manifest.json - 短期缓存
        location ~ /weather_duck/manifest\.json$ {
            alias /usr/share/nginx/html/weather_duck/manifest.json;
            add_header Cache-Control "public, max-age=3600";
        }
        
        # 静态资源 - 长期缓存（带版本号的assets文件）
        location ~ /weather_duck/assets/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # 其他静态资源 - 中期缓存
        location ~ /weather_duck/.*\.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
        
        # SPA路由处理 - 所有路由都返回index.html
        try_files $uri $uri/ /weather_duck/index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name yangruoji.com;
    
    # 强制HTTPS
    return 301 https://$host$request_uri;
}